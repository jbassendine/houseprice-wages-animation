<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <style>
  .localDistricts {
    stroke: white;
    stroke-width: 0.5;
  }
  .selected {
    stroke: black;
    stroke-width: 2;
  }
  .year-text {
    margin: 40px 0 0 40px;
    font-size: 3.5em;
  }
  .map-div,
  .national-div,
  .lad-div {
    float:left;
  }
  .national-chart-path {
    stroke: black;
    stroke-width: 5;
    fill: none;
  }
  .lad-chart-path {
    stroke: black;
    stroke-width: 5;
    fill: none;
  }
  .headline-number {
    font-size: 35px;
  }
  </style>
</head>
<body>
  <div class='year-text'><span id='year'>1999</span></div>
  <div><div class="map-div"></div></div>
  <div class="national-div">
    <h2><span id='national'>Accept geolocation or click on map to get local data.</span></h2>
    <div class="national-chart-div"></div>
    <div><span class="headline-number national-housing-ratio"></span> years of the average full-time wage to buy an average house.</div>
    <div><span class="headline-number national-mortgage-payoff-period"></span> years to pay off a mortgage on the average full-time wage.</div>
  </div>
  <div class="lad-div">
    <h2><span id='lad'>Accept geolocation or click on map to get local data.</span></h2>
    <div class="lad-chart-div"></div>
    <div><span class="headline-number lad-housing-ratio"></span> years of the average full-time local wage to buy an average house.</div>
    <div><span class="headline-number lad-mortgage-payoff-period"></span> years to pay off a mortgage on the average full-time wage.</div>
  </div>
</body>
<script src='lib/d3.js'></script>
<script src='lib/topojson.js'></script>
<script src='lib/d3-queue.js'></script>
<script>

var svg,
    path,
    currentlySelected = {},
    ratioScale,
    projection,
    lineFct,
    dataset,
    nationalData,
    LADData,
    startYear = 1999,
    endYear = 2015,
    currentYear = startYear,
    stepTiming = 650,
    timer,
    mapWidth = 700,
    mapHeight = 900,
    chartMargin = {top: 20, right: 20, bottom: 50, left: 70}
    chartWidth = 330,
    chartHeight = 230;

d3.selection.prototype.moveToFront = function() {
  return this.each(function(){
    this.parentNode.appendChild(this);
  });
};

var initialize = function() {
  setupMap();
  loadData();

  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var LADElement = returnSVGFromPoint(position.coords.latitude, position.coords.longitude);
      updateLADChart(LADElement);
    });
  }
}

var setupMap = function() {
  var width = mapWidth;
  var height = mapHeight;

  // var projection = d3.geo.albers();
  projection = d3.geo.albers()   // define our projection with parameters
    //.precision()
    .scale(5000)
    //.translate([-800, 800])
    .rotate(90)
    .center([1, 57]);

  path = d3.geo.path().projection(projection);

  svg = d3.select('.map-div')
        .append('svg')
        .attr('height', height)
        .attr('width', width)
        .append('g');
}

var setupNationalChart = function() {
  //TODO: Chart height to client screen height
  var nationalSVG = d3.select('.national-chart-div').append('svg')
                     .attr('class', 'lad-chart-svg')
                     .attr("width", chartWidth + chartMargin.left + chartMargin.right)
                     .attr("height", chartHeight + chartMargin.top + chartMargin.bottom);
  setupXAxisAndReturnScale(nationalSVG, 'national-chart-xaxis');
  setupYAxisAndReturnScale(nationalSVG, 'national-chart-yaxis');
  nationalSVG.append("g")
            .attr("class", "national-chart-rects")
            .attr("transform", "translate(" + (chartMargin.left - 5) + "," + chartMargin.top + ")");
  nationalSVG.append("path")
           .attr("class", "national-chart-path")
           .attr("transform", "translate(" + (chartMargin.left - 5) + "," + chartMargin.top + ")");
}

var updateNationalChart = function (ID) {
  switch (ID.slice(0,1)) {
    case('E'):
      ID = 'E92000001';
      break;
    case('W'):
      ID = 'W92000004';
      break;
    case('S'):
      ID = 'S92000003';
      break;
  }

  retrieveChartDataById(ID, function(nationalDataRaw) {
    nationalData = nationalDataRaw;

    document.getElementById('national').innerHTML = nationalDataRaw.LADname;

    // //Reformat for chart
    // nationalData = reformatChartDataForLineFct(nationalDataRaw);

    //Find max
    var max = 0;
    max = d3.max(nationalData.yearlyData, function(d) {
      if (!isNaN(d.ratio)) return Number(d.ratio);
    });

    var nationalSVG = d3.select('.national-chart-svg');
    var nationalXScale = setupXAxisAndReturnScale(nationalSVG, 'national-chart-xaxis');
    var nationalYScale = setupYAxisAndReturnScale(nationalSVG, 'national-chart-yaxis', max);

    //Update line function
    nationalLineFct = d3.svg.line()
                .x(function(d) {return nationalXScale(d.currentYear)})
                .y(function(d) {return nationalYScale(d.ratio)});

    if (!timer) {
      animationStep();
    }
  });
}

var setupLADChart = function() {
  var LADSVG = d3.select('.lad-chart-div').append('svg')
                     .attr('class', 'lad-chart-svg')
                     .attr("width", chartWidth + chartMargin.left + chartMargin.right)
                     .attr("height", chartHeight + chartMargin.top + chartMargin.bottom);
  setupXAxisAndReturnScale(LADSVG, 'lad-chart-xaxis');
  setupYAxisAndReturnScale(LADSVG, 'lad-chart-yaxis');
  LADSVG.append("g")
            .attr("class", "lad-chart-rects")
            .attr("transform", "translate(" + (chartMargin.left - 5) + "," + chartMargin.top + ")");
  LADSVG.append("path")
           .attr("class", "lad-chart-path")
           .attr("transform", "translate(" + (chartMargin.left - 5) + "," + chartMargin.top + ")")
}

var updateLADChart = function(SVGTargetElement) {
  //Highlight LAD
  if (Object.keys(currentlySelected).length !== 0) {
    var unselectedClassList = currentlySelected.getAttribute('class').replace(new RegExp('(\\s|^)' + "selected" + '(\\s|$)', 'g'), '$2');
    currentlySelected.setAttribute('class', unselectedClassList);
  }
  svg.selectAll('.localDistricts')
    .sort(function(a,b) {
      return (a.id == SVGTargetElement.id) - (b.id == SVGTargetElement.id);
    })
  document.getElementById(SVGTargetElement.id).setAttribute('class', SVGTargetElement.getAttribute('class') + ' selected');
  currentlySelected = SVGTargetElement;

  //Find ID
  var LADElementID = SVGTargetElement.id;

  updateNationalChart(LADElementID);

  retrieveChartDataById(LADElementID, function(LADDataRaw) {
    document.getElementById('lad').innerHTML = LADDataRaw.LADname;

    LADData = LADDataRaw;

    //Find max
    var max = 0;
    max = d3.max(LADData.yearlyData, function(d) {
      return Number(d.ratio);
    });

    var LADSVG = d3.select('.lad-chart-svg');
    var LADXScale = setupXAxisAndReturnScale(LADSVG, 'lad-chart-xaxis');
    var LADYScale = setupYAxisAndReturnScale(LADSVG, 'lad-chart-yaxis', max);

    //Update line function
    LADLineFct = d3.svg.line()
                .x(function(d) {return LADXScale(d.currentYear)})
                .y(function(d) {return LADYScale(d.ratio)});

    if (!timer) {
      animationStep();
    }
  });
}

var setupXAxisAndReturnScale = function (LADSVG, inputClass) {
  var LADXScale = d3.scale.linear()
                              .domain([startYear, endYear])
                              .range([0, chartWidth]);


  var LADXAxis = d3.svg.axis().scale(LADXScale)
                              .tickValues(d3.range(startYear, endYear + 1, 1))
                              .tickFormat(d3.format("d"));

  if (!document.getElementsByClassName(inputClass).length) {
    var LADXAxisGroup = LADSVG.append("g")
                                      .attr('class', inputClass)
                                      .attr("transform", "translate(" + (chartMargin.left - 30) + "," + (chartHeight + chartMargin.top) + ")")
                                      .call(LADXAxis)

                                      .selectAll("text")
                                      .attr("y", 0)
                                      .attr("x", -50)
                                      .attr("dy", ".35em")
                                      .attr("transform", "rotate(-90)")
                                      .style("text-anchor", "start");
  }
  return LADXScale;
}

var setupYAxisAndReturnScale = function (SVG, inputClass, max) {
  if (!max) max = 7.25;
  var yScale = d3.scale.linear()
                              .domain([0, max])
                              .range([chartHeight, 0])
                              .nice();

  var yAxis = d3.svg.axis().orient("left")
                           .scale(yScale);

  if (!document.getElementsByClassName(inputClass).length) {
    var yAxisGroup = SVG.append("g")
                                      .attr('class', inputClass)
                                      .attr("transform", "translate(" + (chartMargin.left - 30) + "," + chartMargin.top + ")")
                                      .call(yAxis);
  } else {
    d3.select(".lad-chart-yaxis").call(yAxis);
  }

  return yScale;
}

var loadData = function() {
  d3_queue.queue().defer(d3.csv, 'data/reconstructedratioprocessed.csv')
         .defer(d3.json, 'data/topo-lad-simplified.json')
         .await(function(error, houseData, localDistricts) {
           processMapData(houseData, localDistricts);
         });
}

var findMapDataById = function(ID) {
  for (var i = 0; i < dataset.length; i++) {
    var id = dataset[i].id;
    if (ID === dataset[i].id) {
      return dataset[i];
    }
  };
  var newIndex = dataset.push({"id": ID}) - 1;
  return dataset[newIndex];
};

var retrieveChartDataById = function(ID, callbackFunction) {
  d3_queue.queue()
         .defer(d3.json, 'data/LADs/' + ID + '.json')
         .await(function(error, LADdata) {
           callbackFunction(LADdata);
         });
}

var processMapData = function(houseData, localDistricts) {

  dataset = topojson.feature(localDistricts, localDistricts.objects.lad1).features;

  var min = 0,
      max = 0;

  houseData.forEach(function(HDcurrentValue) {
    var LDvalue = findMapDataById(HDcurrentValue.LADid)
    delete HDcurrentValue[""];
    LDvalue.pricingRatioData = HDcurrentValue;
  });

  ratioScale = d3.scale.linear()
                    .domain([0, 9.99])
                    .range(['yellow', 'red']);

  bindAndDrawMap();
  setupNationalChart();
  setupLADChart();
}

var isPointInPoly = function (poly, pt) {
//+ Jonas Raoni Soares Silva
//@ http://jsfromhell.com/math/is-point-in-poly [rev. #0]
  for(var c = false, i = -1, l = poly.length, j = l - 1; ++i < l; j = i)
    ((poly[i][1] <= pt.y && pt.y < poly[j][1]) || (poly[j][1] <= pt.y && pt.y < poly[i][1]))
    && (pt.x < (poly[j][0] - poly[i][0]) * (pt.y - poly[i][1]) / (poly[j][1] - poly[i][1]) + poly[i][0])
    && (c = !c);
  return c;
}

var returnSVGFromPoint = function (lat, lng) {
  var PtOnSVGScale = projection([lng, lat]);//Todo match up
  var SVGposition = svg[0][0].getBoundingClientRect();
  return document.elementFromPoint(SVGposition.left + PtOnSVGScale[0], SVGposition.top + PtOnSVGScale[1]);
}

var reformatChartDataForLineFct = function(HDvalue) {
  var newHDvalue = {};
  newHDvalue.data = [];
  for (var key in HDvalue) {
    if (HDvalue.hasOwnProperty(key)) {
      if (key.match(/[0-9]{4}/)) {
        newHDvalue.data.push(
          {
            "year": key,
            "ratio": HDvalue[key].ratio
          }
        );
      };
    };
  }
  newHDvalue.id = HDvalue.LADid;
  return newHDvalue;
}



var bindAndDrawMap = function() {

  svg.selectAll('.localDistricts')
    .data(dataset)
    .enter()
    .append('path')
    .attr('class', 'localDistricts')
    .attr('id', function(d) {return d.id})
    .attr('d', path)
    .attr('fill', 'white')
    .on("mouseover", function() {})
    .on("mouseout", function() {})
    .on("click", function(select) {
      if (currentlySelected.id !== this.id) {
        updateLADChart(this);
      }
    });
  startAnimationLoop();
}

var fillColourOnRatio = function(ratio) {
  var returnColour = ratioScale(ratio);
  if (returnColour == '#NaNNaNNaN') {
    returnColour = 'lightgray';
  }
  return returnColour
}

var startAnimationLoop = function() {
  timer = window.setInterval(function() {
    document.getElementById('year').innerHTML = currentYear;
    if (currentYear == endYear) {
      window.clearInterval(timer);
      timer = 0;
      window.setTimeout(function() {
        currentYear = startYear;
        startAnimationLoop();
      }, 3000)
    } else {
      currentYear++;
    }
    animationStep();
  }, stepTiming)
}

var getLineSegment = function(currentYear, data) {
  var interpolatedArraySegment = data.yearlyData.slice(0, currentYear - startYear);
  var interpolatedLineSegment = [];
  interpolatedArraySegment.forEach(function(currentValue) {
    if (!isNaN(currentValue.ratio)) interpolatedLineSegment.push(
      {
        "ratio": currentValue.ratio,
        "currentYear": currentValue.currentYear
      }
    );
  })

  if (interpolatedLineSegment.length === 0) {
    interpolatedLineSegment =
    {
      "ratio": 0,
      "currentYear": 1997
    }
  }

  return interpolatedLineSegment;
}

var findDataForYearFromJSONArray = function(data, currentYear, targetKey) {
  if (data.yearlyData && data.yearlyData[currentYear - startYear][targetKey] !== "Null") {
    return data.yearlyData[currentYear - startYear][targetKey].toFixed(0);
  } else {
    return "-";
  }
}

var animationStep = function() {
  svg.selectAll('.localDistricts')
    .transition()
    .duration(stepTiming)
    .attr('fill', function(d) {
      return fillColourOnRatio(d.pricingRatioData[currentYear]);
    });

  //Test whether a local area has been selected, and a LAD JSON file returned and added as the LADData global
  if (LADData) {
    document.getElementsByClassName("national-housing-ratio")[0].textContent = findDataForYearFromJSONArray(nationalData, currentYear, "ratio");
    document.getElementsByClassName("national-mortgage-payoff-period")[0].textContent = findDataForYearFromJSONArray(nationalData, currentYear, "mortgagePeriod");

    document.getElementsByClassName("lad-housing-ratio")[0].textContent = findDataForYearFromJSONArray(LADData, currentYear, "ratio");
    document.getElementsByClassName("lad-mortgage-payoff-period")[0].textContent = findDataForYearFromJSONArray(LADData, currentYear, "mortgagePeriod");

    var nationalLineSegment = getLineSegment(currentYear, nationalData);
    d3.select('.national-chart-path')
       .transition()
       .duration(stepTiming)
       .attr('d', function() {
         console.log(currentYear);
         return nationalLineFct(nationalLineSegment);
       });

    var ladLineSegment = getLineSegment(currentYear, LADData);
    d3.select('.lad-chart-path')
      .transition()
      .duration(stepTiming)
      .attr('d', function() {
        return LADLineFct(ladLineSegment);
      });

    var rects = d3.select('.lad-chart-rects')
      .selectAll('rects')
        .data(ladLineSegment, function (d) {
          return d.currentYear;
        });

    console.log(rects.enter());
    rects.enter().append('rect')
        .attr('class', "test")
        .attr('height', 230)
        .attr('width', 20)
        .attr('x', function (d) {
          var xDisp = (d.currentYear - startYear) * 20 - 5;
          return xDisp;
        })
        .attr('y', 0)
        .attr('fill', function (d) {
          return fillColourOnRatio (d.ratio);
        });
    console.log(rects.exit());
    rects.exit().remove();

    var nationalLineSegment = getLineSegment(currentYear, nationalData);
    var rects = d3.select('.national-chart-rects')
      .selectAll('rects')
        .data(nationalLineSegment);

    rects.enter().append('rect')
        .attr('class', "test")
        .attr('height', 230)
        .attr('width', 20)
        .attr('x', function (d) {
          var xDisp = (d.currentYear - startYear) * 20 - 5;
          return xDisp;
        })
        .attr('y', 0)
        .attr('fill', function (d) {
          return fillColourOnRatio (d.ratio);
        });

    rects.exit().remove();
  }
}

window.onload = initialize();

</script>
</html>
